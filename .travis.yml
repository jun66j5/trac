language: python
sudo: false
cache:
  directories:
    - "$HOME/.cache/pip"
    - "$HOME/.pyenv"
addons:
  apt:
    packages:
      - python-subversion
matrix:
  include:
    - os: linux
      python: "2.6"
      env: tracdb=
    - os: linux
      python: "2.6"
      env: tracdb=sqlite
    - os: linux
      python: "2.6"
      env: tracdb=postgres
    - os: linux
      python: "2.6"
      env: tracdb=mysql
    - os: linux
      python: "2.7_with_system_site_packages"
      env: tracdb=
    - os: linux
      python: "2.7_with_system_site_packages"
      env: tracdb=sqlite
    - os: linux
      python: "2.7_with_system_site_packages"
      env: tracdb=postgres
    - os: linux
      python: "2.7_with_system_site_packages"
      env: tracdb=mysql
    - os: osx
      language: generic
      env: pyver=2.6.6 tracdb=
    - os: osx
      language: generic
      env: pyver=2.6.6 tracdb=sqlite
    - os: osx
      language: generic
      env: pyver=2.6.6 tracdb=postgres
    - os: osx
      language: generic
      env: pyver=2.7.10 tracdb=
    - os: osx
      language: generic
      env: pyver=2.7.10 tracdb=sqlite
    - os: osx
      language: generic
      env: pyver=2.7.10 tracdb=postgres
before_install:
  - |
    set -e
    case "$tracdb" in
      postgres)
        if [ "$TRAVIS_OS_NAME" = osx ]; then
          pg_ctl -w start --pgdata /usr/local/var/postgres
          createuser -s postgres
        fi
        psql -U postgres -c "CREATE USER tracuser NOSUPERUSER NOCREATEDB CREATEROLE PASSWORD 'password';"
        psql -U postgres -c "CREATE DATABASE trac OWNER tracuser;"
        ;;
      mysql)
        mysql -u root -e "CREATE DATABASE trac DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;"
        mysql -u root -e "CREATE USER tracuser@localhost IDENTIFIED BY 'password';"
        mysql -u root -e "GRANT ALL ON trac.* TO tracuser@localhost; FLUSH PRIVILEGES;"
        ;;
    esac
    if [ "$TRAVIS_OS_NAME" = osx ]; then
      PYENV_ROOT=$HOME/.pyenv
      PATH=$PYENV_ROOT/shims:$PATH:$PYENV_ROOT/bin
      export PYENV_ROOT PATH
      brew update >/dev/null
      brew outdated pyenv || brew upgrade --quiet pyenv
      pyenv install -ks $pyver
      pyenv global $pyver
    fi
install:
  - |
    set -e
    pip install --upgrade pip
    pip install Genshi==0.7 Babel configobj Pygments docutils lxml pytz twill==0.9.1
    pip freeze
    case "$tracdb" in
      sqlite)
        echo '.uri = sqlite:test.db' >Makefile.cfg
        ;;
      postgres)
        pip install psycopg2
        echo '.uri = postgres://tracuser:password@localhost/trac?schema=tractest' >Makefile.cfg
        ;;
      mysql)
        pip install MySQL-python
        echo '.uri = mysql://tracuser:password@localhost/trac' >Makefile.cfg
        ;;
      *)
        echo '.uri = ' >Makefile.cfg
        ;;
    esac
script:
  - make Trac.egg-info compile unit-test functional-test
